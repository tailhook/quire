#include <sys/queue.h>
#include <stdio.h>
#include <assert.h>

#include "header.h"
#include "struct.h"
#include "../yaml/parser.h"
#include "../yaml/codes.h"
#include "util/name.h"
#include "util/print.h"
#include "../yaml/access.h"


int qu_output_header(qu_context_t *ctx) {
    qu_code_print(ctx,
        "/*  DO NOT EDIT THIS FILE!  */\n"
        "/*  This file is generated  */\n"
        "#ifndef HEADER_${mpref}\n"
        "#define HEADER_${mpref}\n"
        "\n"
        "#include <quire.h>\n"
        "\n"
        , NULL);

    qu_code_print(ctx,
        "\n"
        "/*  Forward declarations  */\n"
        "\n"
        , NULL);

    qu_fwdecl_print_all(ctx);

    qu_code_print(ctx,
        "\n"
        "/*  Intermediate command-line storage  */\n"
        "\n"
        , NULL);
    qu_cli_print_struct(ctx);


    qu_code_print(ctx,
        "\n"
        "/*  Main configuration structure  */\n"
        "\n"
        , NULL);

    qu_code_print(ctx,
        "struct ${pref}_main {\n"
        "    qu_config_head head;\n"
        , NULL);
    if(ctx->root) {
        qu_struct_definition(ctx, ctx->root);
    }
    qu_code_print(ctx,
        "};\n"
        "\n",
        NULL);

    qu_cli_print_fwdecl(ctx);
    qu_code_print(ctx,
        "int ${pref}_load(struct ${pref}_main *cfg, int argc, char **argv);\n"
        "int ${pref}_parse(struct qu_config_context *ctx, struct ${pref}_cli *cli, "
                          "struct ${pref}_main *cfg);\n"
        "int ${pref}_set_defaults(struct ${pref}_main *cfg);\n"
        "void ${pref}_print(struct ${pref}_main *cfg, int flags, FILE *);\n"
        "void ${pref}_help(FILE *);\n"
        "void ${pref}_free(struct ${pref}_main *cfg);\n"
        "\n"
        "#endif  /*  HEADER_${mpref}  */\n"
        , NULL);
    return 0;
}
